<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Playlog</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./introduction.html"><strong>1.</strong> Introduction</a></li><li><a href="./install/index.html"><strong>2.</strong> Installation</a></li><li><ul class="section"><li><a href="./install/docker.html"><strong>2.1.</strong> Docker</a></li><li><a href="./install/manual.html"><strong>2.2.</strong> Manual</a></li></ul></li><li><a href="./upgrade.html"><strong>3.</strong> Upgrade</a></li><li><a href="./configuration.html"><strong>4.</strong> Configuration</a></li><li><a href="./development.html"><strong>5.</strong> Development</a></li><li><a href="./release.html"><strong>6.</strong> Release</a></li><li><a href="./submissions.html"><strong>7.</strong> Submissions API</a></li><li class="spacer"></li><li class="affix"><a href="./changelog.html">CHANGELOG</a></li><li class="affix"><a href="./todo.html">TODO</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Playlog</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="print.html#introduction" id="introduction"><h1>Introduction</h1></a>
<p><strong>Playlog</strong> is a self-hosted scrobbling<sup class="footnote-reference"><a href="print.html#scrobbling">1</a></sup> server.
It allows you to collect and view the statistics of scrobbles.
Unlike other services (last.fm, libre.fm) playlog is intended for the sole use.
This means you are not albe to create more than one account.
At this moment it supports legacy <a href="submissions.html">Submissions API</a>
only. So some music players won't work.
There are plans to create a custom API with proxies
for Submissions and <a href="https://www.last.fm/api/scrobbling">Scrobbling API</a> support.</p>
<p>Let's see how it looks like:</p>
<p><a href="./screenshot.png"><img src="./screenshot.png" alt="screenshot" /></a></p>
<p>If you are interested, go to the next section and try!</p>
<a class="header" href="print.html#license" id="license"><h2>License</h2></a>
<p>Playlog is licensed under <a href="https://github.com/rossnomann/playlog/blob/master/LICENSE">The MIT License (MIT)</a>.</p>
<p><sup class="footnote-reference"><a href="print.html#scrobbling">1</a></sup> Scrobbling is a term invented by Last.fm to describe the logging of songs that
you listen to.</p>
<a class="header" href="print.html#installation" id="installation"><h1>Installation</h1></a>
<p>Install common requirements:</p>
<ul>
<li>PostgreSQL 9.5 or higher</li>
<li>Redis (tested on 4.0 but other versions also should work)</li>
<li>NGINX (or any other server on your choice)</li>
</ul>
<p>and follow to <a href="install/docker.html">docker</a>
or <a href="install/manual.html">manual</a> installation instructions.</p>
<a class="header" href="print.html#install-using-docker" id="install-using-docker"><h1>Install using docker</h1></a>
<p>Make sure that you have installed:</p>
<ul>
<li>Docker</li>
<li>docker-compose</li>
</ul>
<p>Create <code>docker-compose.yml</code>:</p>
<pre><code class="language-yaml">version: '3.4'
services:
  app:
    image: rossnomann/playlog:%version%
    environment:
      PLAYLOG_SA_URL: postgresql://user:password@127.0.0.1/database
      PLAYLOG_REDIS_URL: redis://127.0.0.1:6379
      PLAYLOG_SUBMISSIONS_BASE_URL: 'http://%your-domain%'
      PLAYLOG_SUBMISSIONS_HANDSHAKE_TIMEOUT: 30
      PLAYLOG_USER_NAME: '%your_name%'
      PLAYLOG_USER_EMAIL: '%your_email%'
      PLAYLOG_SUBMISSIONS_USER: '%your-login%'
      PLAYLOG_SUBMISSIONS_PASSWORD_HASH: '%md5_hash_of_password%'
    network_mode: host
    container_name: playlog

</code></pre>
<p>Don't forget to replace <code>%version%</code> and other placeholders.
Available versions are listed <a href="https://hub.docker.com/r/rossnomann/playlog/tags/">here</a>.</p>
<p>Run <code>docker-compose up</code> and <code>docker exec playlog ./backend/bin/alembic migrate head</code></p>
<p>Ports:</p>
<ul>
<li>8000 - API</li>
<li>8001 - Frontend</li>
</ul>
<p>NGINX config example:</p>
<pre><code class="language-nginx">server {
    listen 80;
    server_name %your-domain%;

    location / {
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass http://127.0.0.1:8001;
    }

    location /api/ {
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_pass              http://127.0.0.1:8000/;
    }
}

</code></pre>
<a class="header" href="print.html#install-manually" id="install-manually"><h1>Install manually</h1></a>
<p>Ensure that you have installed:</p>
<ul>
<li>Python &gt;= 3.5</li>
<li>NodeJS</li>
</ul>
<p>Clone repository:</p>
<pre><code class="language-sh">git clone https://github.com/rossnomann/playlog.git
</code></pre>
<p>Create and activate python virtual environment:</p>
<pre><code class="language-sh">python3 -m venv ~/.venv/playlog
source ~/.venv/playlog/bin/activate
</code></pre>
<p>Install requirements:</p>
<pre><code class="language-sh">cd playlog/backend
pip install -r requirements/main.txt
</code></pre>
<p>Configure backend:</p>
<pre><code class="language-sh">export PYTHONPATH=/path/to/playlog/backend/src:$PYTHONPATH
export PLAYLOG_DEBUG='false'
export PLAYLOG_SERVER_HOST='127.0.0.1'
export PLAYLOG_SERVER_PORT='8080'
export PLAYLOG_SA_URL='postgresql://playlog:password@localhost/playlog'
export PLAYLOG_REDIS_URL='redis://127.0.0.1:6379'
export PLAYLOG_USER_NAME='John Doe'
export PLAYLOG_USER_EMAIL='your-email-for-gravatar'
export PLAYLOG_SESSION_LIFETIME='86400'
export PLAYLOG_SUBMISSIONS_BASE_URL='http://domain/api'
export PLAYLOG_SUBMISSIONS_HANDSHAKE_TIMEOUT='60'
export PLAYLOG_SUBMISSIONS_USER='john'
export PLAYLOG_SUBMISSIONS_PASSWORD_HASH='md5-hash-of-password'
</code></pre>
<p>Run migrations:</p>
<pre><code class="language-sh">./bin/alembic migrate head
</code></pre>
<p>Run server:</p>
<pre><code class="language-sh">./bin/server
</code></pre>
<p>Install frontend dependencies:</p>
<pre><code class="language-sh">cd path/to/playlog/frontend
npm install
</code></pre>
<p>Build frontend:</p>
<pre><code class="language-sh">npm run build
</code></pre>
<p>NGINX config:</p>
<pre><code class="language-nginx">server {
    listen      80;
    server_name domain;
    root        /path/to/playlog/frontend/build;
    error_log   /var/log/nginx/playlog.log;

    location / {
        try_files $uri /index.html;
    }

    location /api/ {
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_pass              http://127.0.0.1:8080/;
    }
}

</code></pre>
<a class="header" href="print.html#upgrading-from-previous-versions" id="upgrading-from-previous-versions"><h1>Upgrading from previous versions</h1></a>
<ol>
<li>Read <a href="changelog.html">changelog</a>.</li>
<li>Stop application.</li>
<li>Create a backup.</li>
<li>Checkout to a new version or pull a new <a href="https://hub.docker.com/r/rossnomann/playlog/tags/">docker image</a>.</li>
<li>Update configuration parameters (if required, there should be a note in changelog).</li>
<li>Update dependencies in case of manual installation (see <a href="install/manual.html">install section</a>).</li>
<li>Run migrations:
<ul>
<li><code>docker exec playlog ./backend/bin/alembic migrate head</code></li>
<li>or just <code>bin/alembic migrate head</code> if you've installed manually.</li>
</ul>
</li>
<li>Launch application.</li>
</ol>
<a class="header" href="print.html#configuration" id="configuration"><h1>Configuration</h1></a>
<a class="header" href="print.html#server" id="server"><h2>Server</h2></a>
<p>Server reads config from the following environment variables:</p>
<ul>
<li><code>PLAYLOG_DEBUG</code> - Debug mode: <code>true</code> or <code>false</code>.</li>
<li><code>PLAYLOG_SERVER_HOST</code> - TCP/IP hostname to serve on.</li>
<li><code>PLAYLOG_SERVER_PORT</code> - TCP/IP port to serve on.</li>
<li><code>PLAYLOG_SA_URL</code> - SQLAlchemy URL in the following format: <code>postgresql://user:pass@host:port/database</code>.</li>
<li><code>PLAYLOG_REDIS_URL</code> - Redis URL like <code>redis://127.0.0.1:6379/0</code>.</li>
<li><code>PLAYLOG_USER_NAME</code> - An arbitrary username (John Doe for example).</li>
<li><code>PLAYLOG_USER_EMAIL</code> - Your email (currently used for gravatar only, not required).</li>
<li><code>PLAYLOG_SESSION_LIFETIME</code> - User session lifetime in seconds.</li>
<li><code>PLAYLOG_SUBMISSIONS_BASE_URL</code> - Base URL for submissions handshake response
(<code>http://127.0.0.1:5051</code> for example).</li>
<li><code>PLAYLOG_SUBMISSIONS_HANDSHAKE_TIMEOUT</code> - Submissions handshake timeout in seconds (30 should be enough).</li>
<li><code>PLAYLOG_SUBMISSIONS_USER</code> - Login for submissions API.</li>
<li><code>PLAYLOG_SUBMISSIONS_PASSWORD_HASH</code> - MD5 hash of password for submissions API.</li>
</ul>
<a class="header" href="print.html#client" id="client"><h2>Client</h2></a>
<p>Make sure that your player supports <a href="https://www.last.fm/api/submissions">Last.fm Submissions Protocol</a>.</p>
<ul>
<li>Scrobbling address: <a href="http://your-host/api/submissions">http://your-host/api/submissions</a></li>
<li>Username: a value from <code>PLAYLOG_SUBMISSIONS_USER</code></li>
<li>Password: a string used for <code>PLAYLOG_SUBMISSIONS_PASSWORD_HASH</code></li>
</ul>
<p>Note: If you are not able to specify scrobbling address,
you can try to setup a proxy (using NGINX for example).</p>
<a class="header" href="print.html#development" id="development"><h1>Development</h1></a>
<p>Requirements:</p>
<ul>
<li>Docker</li>
<li>docker-compose</li>
<li>NodeJS</li>
</ul>
<p>Fork and clone repository:</p>
<pre><code class="language-sh">git clone https://github.com/%username%/playlog.git
cd playlog
</code></pre>
<p>Install frontend dependencies:</p>
<pre><code class="language-sh">cd frontend &amp;&amp; npm install &amp;&amp; cd ..
</code></pre>
<p>Build docker image:</p>
<pre><code class="language-sh">./bin/build
</code></pre>
<p>Create <code>backend/.env</code> file:</p>
<pre><code class="language-env">PLAYLOG_USER_NAME=John Doe
PLAYLOG_USER_EMAIL=johndoe@protonmail.com
PLAYLOG_SUBMISSIONS_USER=john
# Password: 1234
PLAYLOG_SUBMISSIONS_PASSWORD_HASH=81dc9bdb52d04dc20036dbd8313ed055
</code></pre>
<p>You also can create <code>docker-compose.overrides.yml</code> in order to override some preferences:</p>
<pre><code class="language-yaml">version: '3.4'
networks:
  default:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1492
</code></pre>
<p>Run app:</p>
<pre><code class="language-sh">./bin/start
</code></pre>
<p>Run tests:</p>
<pre><code class="language-sh"># use --build flag to rebuild image
./bin/test
</code></pre>
<a class="header" href="print.html#documentation" id="documentation"><h2>Documentation</h2></a>
<ul>
<li>Install <a href="https://github.com/rust-lang-nursery/mdBook">mdBook</a>.</li>
<li>Create feature branch (<code>git checkout -b docs/%topic%</code>)</li>
<li>Make your changes.</li>
<li>Preview with: <code>bin/docs serve --open</code>.</li>
<li>Publish changes and send a pull request.</li>
</ul>
<a class="header" href="print.html#contributing" id="contributing"><h2>Contributing</h2></a>
<ul>
<li>Create feature branch (<code>git checkout -b feature/%topic%</code>).</li>
<li>Make changes.</li>
<li>Update README.md if it's necessary.</li>
<li>Commit and push (git push origin <code>feature/%topic%</code>).</li>
<li>Send a pull request.</li>
</ul>
<a class="header" href="print.html#how-to-release-a-new-version" id="how-to-release-a-new-version"><h1>How to release a new version</h1></a>
<ol>
<li>Ensure development requirements.</li>
<li>Run tests.</li>
<li>Update documentation, README and other stuff (if required).</li>
<li>Update CHANGELOG (<code>docs/src/changelog.md</code>).</li>
<li>Update TODO (<code>docs/src/todo.md</code>)</li>
<li>Run <code>bin/build production &lt;version&gt;</code>, where <code>&lt;version&gt;</code> is a target version.</li>
<li>Push the image to docker hub <code>docker push rossnomann/playlog:&lt;version&gt;</code>.</li>
<li>Make a release on GitHub.</li>
</ol>
<a class="header" href="print.html#lastfm-submissions-protocol" id="lastfm-submissions-protocol"><h1>Last.fm Submissions Protocol</h1></a>
<p>Source: <a href="https://www.last.fm/api/submissions">https://www.last.fm/api/submissions</a></p>
<a class="header" href="print.html#introduction-and-scope" id="introduction-and-scope"><h2>Introduction and Scope</h2></a>
<p>The Submissions Protocol is designed for the submission of now-playing and recent historical track
data to Last.fm user profiles (aka &quot;Scrobbling&quot;). Submission of bulk historical data is not
catered for by this protocol.</p>
<p>The protocol is designed to be as simple and lightweight as possible. It is a REST-style interface
based on HTTP, so a working knowledge of HTTP 1.1 is assumed.</p>
<a class="header" href="print.html#protocol-stages" id="protocol-stages"><h3>Protocol Stages</h3></a>
<p>The protocol consists of three stages which must be performed in the following order:</p>
<ol>
<li>Hadshake
The initial negotiation with the submissions server to establish authentication and
connection details for the session.</li>
<li>Now-Playing
Optional lightweight notification of now-playing data at the start of the
track for realtime information purposes.</li>
<li>Submission
Submission of full track data at the end of the track for statistical purposes.
Typically a client should perform the handshake once at the start of a listening session
and then use the values returned to perform as many now-playing and submission requests as
required (i.e. the handshake does not need to be performed for every track submitted, just once).</li>
</ol>
<a class="header" href="print.html#hadshake" id="hadshake"><h2>Hadshake</h2></a>
<p>A handshake must occur each time a client is started, and additionally
if failures are encountered later on in the submission process.</p>
<p>The handshake consists of a HTTP/1.1 GET request to this URL:</p>
<pre><code>http://post.audioscrobbler.com:80/
</code></pre>
<p>Note that the request must be HTTP/1.1 â€” specifically the <code>Host:</code> header should be present.</p>
<p>Version 1.2.1 of the protocol introduces a new handshake mechanism to allow
for <a href="https://www.last.fm/api/authentication">Web Services authentication</a> to be used for handshakes.
Whenever possible you should
use this mechanism for performing handshakes, otherwise you may use &quot;standard authentication&quot;.
Both forms of authentication require a base set of parameters, they differ in that web service
authentication requires an extra two parameters and the authentication token is generated
using a different algorithm. This is all explained below.</p>
<p>The request string that is common to both handshake mechanisms is as follows,
note that all parameters must be present:</p>
<pre><code>http://post.audioscrobbler.com/?hs=true&amp;p=1.2.1&amp;c=&lt;client-id&gt;&amp;v=&lt;client-ver&gt;&amp;u=&lt;user&gt;&amp;t=&lt;timestamp&gt;&amp;a=&lt;auth&gt;
</code></pre>
<p>The common parameters and their values are explained below
(strings between angle brackets should be replaced by &quot;real&quot; values):</p>
<ul>
<li><code>hs=true</code>
Indicates that a handshake is requested. Requests without this parameter set to true will
return a human-readable informational message and no handshake will be performed.</li>
<li><code>p=1.2.1</code>
Is the version of the submissions protocol to which the client conforms.</li>
<li><code>c=&lt;client-id&gt;</code>
Is an identifier for the client.</li>
<li><code>v=&lt;client-ver&gt;</code>
Is the version of the client being used.</li>
<li><code>u=&lt;user&gt;</code>
Is the name of the user on who's behalf the request is being performed.</li>
<li><code>t=&lt;timestamp&gt;</code>
Is a UNIX Timestamp representing the current time at which the request is being performed.</li>
<li><code>a=&lt;authentication-token&gt;</code>
Is the authentication token</li>
<li><code>api_key=&lt;api_key&gt;</code>
The API key from your Web Services account. Required for Web Services authentication only.</li>
<li><code>sk=&lt;session_key&gt;</code>
The Web Services session key generated via the
<a href="https://www.last.fm/api/authentication">authentication protocol</a>.
Required for Web Services authentication only.</li>
</ul>
<a class="header" href="print.html#client-identifiers" id="client-identifiers"><h3>Client Identifiers</h3></a>
<p>Client identifiers are used to provide a centrally managed database of the client versions,
allowing clients to be banned if they are found to be behaving undesirably.
The client identifier is associated with a version number on the server,
however these are only incremented if a client is banned and do not have to reflect
the version of the actual client application.</p>
<p>During development, clients which have not been allocated an identifier should use
the identifier <code>tst</code>, with a version number of 1.0.
Do not distribute code or client implementations
which use this test identifier. Do not use the identifiers used by other clients.
To obtain a new client identifier please contact us and provide us with the name
of your client and its homepage address.</p>
<a class="header" href="print.html#authentication-token-for-standard-authentication" id="authentication-token-for-standard-authentication"><h3>Authentication Token for Standard Authentication</h3></a>
<p>Please note that this form of authentication will be removed in the next version of the protocol
so if possible please use Web Services authentication.</p>
<p>The algorithm for generating this token is as follows:</p>
<pre><code>token = md5(md5(password) + timestamp)
</code></pre>
<p>Where <code>md5(password)</code> is an MD5 checksum of the user's <code>password</code> and <code>timestamp</code> is the same
timestamp sent in cleartext in the handshake request via param <code>t</code>.</p>
<p>The md5() function takes a string and returns the 32-byte ASCII hexadecimal representation of
the MD5 hash, using lower case characters for the hex values.
The <code>+</code> operator represents concatenation of the two strings.</p>
<a class="header" href="print.html#authentication-token-for-web-services-authentication" id="authentication-token-for-web-services-authentication"><h3>Authentication Token for Web Services Authentication</h3></a>
<p>Use this if you want to use Last.fm Web Services authentication
(see <a href="https://www.last.fm/api/authentication">authentication</a>)
to create a new scrobbling session. Please note that this is the preferred method of authentication.</p>
<p>The algorithm for generating this token is as follows:</p>
<pre><code>token = md5(shared_secret + timestamp)
</code></pre>
<p>Where <code>shared_secret</code> is the shared secret from your web services account and <code>timestamp</code> is
the same timestamp sent in cleartext in the handshake request via param <code>t</code>.</p>
<p>The <code>md5()</code> function takes a string and returns the 32-byte ASCII hexadecimal
representation of the MD5 hash, using lower case characters for the hex values.
The <code>+</code> operator represents concatenation of the two strings.</p>
<a class="header" href="print.html#handshake-response" id="handshake-response"><h3>Handshake Response</h3></a>
<p>The body of the server response consists of a series of \n (ASCII 10) terminated lines.
A typical successful server response will be something like this:</p>
<pre><code>OK
17E61E13454CDD8B68E8D7DEEEDF6170
http://post.audioscrobbler.com:80/np_1.2
http://post2.audioscrobbler.com:80/protocol_1.2
</code></pre>
<p>If the HTTP status code is not 200 OK (indicating a successful transfer), then this
constitutes a hard failure i.e. the server is not responding to the request as expected
and the client should handle this. Such events may occur during network outages or when
the server is heavily loaded. In addition, 'transparent' proxies may obscure the connection attempt.</p>
<p>The client should consider the first line of the response to determine the action
it should take as follows:</p>
<a class="header" href="print.html#ok" id="ok"><h4><code>OK</code></h4></a>
<p>This indicates that the handshake was successful. Three lines will follow the OK response:</p>
<ul>
<li>Session ID
The scrobble session id, to be used in all following now-playing and submission requests.</li>
<li>Now-Playing URL
The URL that should be used for a now-playing request.</li>
<li>Submission URL
The URL that should be used for a submission request.</li>
</ul>
<p>These values may change per handshake and should be used for one listening
&quot;session&quot; only and not stored across application restarts.</p>
<a class="header" href="print.html#banned" id="banned"><h4><code>BANNED</code></h4></a>
<p>This indicates that this client version has been banned from the server.
This usually happens if the client is violating the protocol in a destructive way.
Users should be asked to upgrade their client application.</p>
<a class="header" href="print.html#badauth" id="badauth"><h4><code>BADAUTH</code></h4></a>
<p>This indicates that the authentication details provided were incorrect.
The client should not retry the handshake until the user has changed their details.</p>
<a class="header" href="print.html#badtime" id="badtime"><h4><code>BADTIME</code></h4></a>
<p>The timestamp provided was not close enough to the current time.
The system clock must be corrected before re-handshaking.</p>
<a class="header" href="print.html#failed-reason" id="failed-reason"><h4><code>FAILED &lt;reason&gt;</code></h4></a>
<p>This indicates a temporary server failure.
The reason indicates the cause of the failure.
The client should proceed as directed in the failure handling section.
All other responses should be treated as a hard failure.An error may be reported to the user,
but as with other messages this should be kept to a minimum.</p>
<a class="header" href="print.html#the-now-playing-notification" id="the-now-playing-notification"><h2>The Now-Playing Notification</h2></a>
<p>The Now-Playing notification is a lightweight mechanism for notifying Last.fm
that a track has started playing. This is used for realtime display of a user's currently playing
track, and does not affect a user's musical profile.</p>
<p>The Now-Playing notification is optional, but recommended and should be sent once when
a user starts listening to a song.</p>
<p>The request takes the form of a group of form encoded key-value pairs which are submitted to the
server as the body of a HTTP POST request, using the now-playing
URL returned by the handshake request. The key-value pairs are:</p>
<ul>
<li><code>s=&lt;sessionID&gt;</code>
The Session ID string returned by the handshake request. Required.</li>
<li><code>a=&lt;artistname&gt;</code>
The artist name. Required.</li>
<li><code>t=&lt;track&gt;</code>
The track name. Required.</li>
<li><code>b=&lt;album&gt;</code>
The album title, or an empty string if not known.</li>
<li><code>l=&lt;secs&gt;</code>
The length of the track in seconds, or an empty string if not known.</li>
<li><code>n=&lt;tracknumber&gt;</code>
The position of the track on the album, or an empty string if not known.</li>
<li><code>m=&lt;mb-trackid&gt;</code>
The MusicBrainz Track ID, or an empty string if not known.</li>
</ul>
<p>The body of the server response will consist of a single \n (ASCII 10) terminated line.
The client should process the first line of the body to determine the action it should take</p>
<ul>
<li><code>OK</code> - indicates that the Now-Playing notification was successful.</li>
<li><code>BADSESSION</code> - indicates that the Session ID sent was somehow invalid,
possibly because another client has performed a handshake for this user.
On receiving this, the client should re-handshake with the server before continuing.</li>
</ul>
<a class="header" href="print.html#the-submission" id="the-submission"><h2>The Submission</h2></a>
<a class="header" href="print.html#when-to-submit" id="when-to-submit"><h3>When to Submit</h3></a>
<p>The client should monitor the user's interaction with the music playing service to whatever
extent the service allows. In order to qualify for submission all
of the following criteria must be met:</p>
<ul>
<li>The track must be submitted once it has finished playing.
Whether it has finished playing naturally or has been manually stopped by the user is irrelevant.</li>
<li>The track must have been played for a duration of at least 240 seconds or half the track's total
length, whichever comes first. Skipping or pausing the track is
irrelevant as long as the appropriate amount has been played.</li>
<li>The total playback time for the track must be more than 30 seconds.
Do not submit tracks shorter than this.</li>
<li>Unless the client has been specially configured, it should not attempt to interpret
filename information to obtain metadata instead of using tags (ID3, etc).</li>
</ul>
<a class="header" href="print.html#submission-stage" id="submission-stage"><h3>Submission Stage</h3></a>
<p>The submission takes place as a HTTP/1.1 POST request to the server,
using the URL returned by the handshake phase of the protocol.
The submission request body may contain the details for up to 50 tracks which are being submitted.
Under normal circumstances only a single track should be submitted per request,
however, clients should cache submissions in case of failure.</p>
<p>The request takes the form of a group of form encoded key-value pairs which are submitted to the
server as the body of the HTTP POST request, using the URL returned by the handshake request.
All specified parameters must be present; they should be left empty if not known.
The example below assumes one track is being submitted as the fields which allow multiple
values are indexed with zero ([0]). The key-value pairs are:</p>
<ul>
<li><code>s=&lt;sessionID&gt;</code>
The Session ID string returned by the handshake request. Required.</li>
<li><code>a[0]=&lt;artist&gt;</code>
The artist name. Required.</li>
<li><code>t[0]=&lt;track&gt;</code>
The track title. Required.</li>
<li><code>i[0]=&lt;time&gt;</code>
The time the track started playing, in UNIX timestamp format (integer number of seconds
since 00:00:00, January 1st 1970 UTC). This must be in the UTC time zone, and is required.</li>
<li><code>o[0]=&lt;source&gt;</code>
The source of the track. Required, must be one of the following codes:
<ul>
<li><code>P</code> - Chosen by the user
(the most common value, unless you have a reason for choosing otherwise, use this).</li>
<li><code>R</code> - Non-personalised broadcast (e.g. Shoutcast, BBC Radio 1).</li>
<li><code>E</code> - Personalised recommendation except Last.fm (e.g. Pandora, Launchcast).</li>
<li><code>L</code> - Last.fm (any mode). In this case, the 5-digit Last.fm recommendation
key must be appended to this source ID to prove the validity of the submission
(for example, <code>o[0]=L1b48a</code>).</li>
</ul>
</li>
<li><code>r[0]=&lt;rating&gt;</code>
A single character denoting the rating of the track. Empty if not applicable.
<ul>
<li><code>L</code> - Love (on any mode if the user has manually loved the track). This implies a listen.</li>
<li><code>B</code> - Ban (only if source=L). This implies a skip,
and the client should skip to the next track when a ban happens.</li>
<li><code>S</code> - Skip (only if source=L)
Note: Currently a Last.fm web service must also be called to set
love (track.love) or ban (track.ban) status. We anticipate that the next version of the
scrobble protocol will no longer perform love and ban and this will instead
be handled by the web services only.</li>
</ul>
</li>
<li><code>l[0]=&lt;secs&gt;</code>
The length of the track in seconds. Required when the source is P, optional otherwise.</li>
<li><code>b[0]=&lt;album&gt;</code>
The album title, or an empty string if not known.</li>
<li><code>n[0]=&lt;tracknumber&gt;</code>
The position of the track on the album, or an empty string if not known.</li>
<li><code>m[0]=&lt;mb-trackid&gt;</code>
The MusicBrainz Track ID, or an empty string if not known.</li>
</ul>
<p>Key-value pairs are separated by an '&amp;' character, in the usual manner for form submissions in HTTP.
The values must be converted to UTF-8 first, and must be URL encoded.
Multiple submissions may be specified by repeating the
<code>a[]</code>, <code>t[]</code>, <code>i[]</code>, <code>o[]</code>, <code>r[]</code>, <code>l[]</code>, <code>b[]</code>, <code>n[]</code>, and <code>m[]</code> key-value pairs
with increasing indices. (e.g. <code>a[1]</code>, <code>a[2]</code> etc.)
Note that when performing multiple submissions, the tracks must be submitted
in chronological order according to when they were listened to
(i.e. the track identified by <code>t[0]</code>.. must have been played
before the track identified by <code>t[1]</code>.. and so on).</p>
<a class="header" href="print.html#submission-response" id="submission-response"><h3>Submission Response</h3></a>
<p>The body of the server response will consist of a single \n (ASCII 10) terminated line.
The client should process the first line of the body to determine the action it should take:</p>
<a class="header" href="print.html#ok-1" id="ok-1"><h4><code>OK</code></h4></a>
<p>This indicates that the submission request was accepted for processing.
It does not mean that the submission was valid, but only that the authentication and the form of
the submission was validated. The client should remove the submitted track(s) from its queue.</p>
<a class="header" href="print.html#badsession" id="badsession"><h4><code>BADSESSION</code></h4></a>
<p>This indicates that the Session ID sent was somehow invalid, possibly because another client has
performed a handshake for this user. On receiving this, the client should re-handshake with the
server before continuing. The client should not remove submitted tracks from its queue.</p>
<a class="header" href="print.html#failed-reason-1" id="failed-reason-1"><h4><code>FAILED &lt;reason&gt;</code></h4></a>
<p>This indicates that a failure has occurred somewhere. The reason indicates the cause of the failure.
Clients should treat this as a hard failure, and should proceed as directed in the
failure handling section. The client should not remove submitted tracks from its queue.</p>
<p>All other responses should be treated as a hard failure.
An error may be reported to the user, but as with other messages this should be kept to a minimum.</p>
<p>The server may at its discretion ignore track details submitted by the user.
Typical reasons for submissions being dropped include (but are not limited to):</p>
<ul>
<li>Submissions with inaccurate dates, e.g. in the far future or past, or before the last submitted
entry (i.e. tracks must be submitted in chronological order according to
when they were listened to).</li>
<li>Spam filtering, such as submissions of tracks with impossible timings
(e.g. tracks played within a few seconds of one another).</li>
<li>Known incorrect tags (e.g. an artist called 'artist')</li>
<li>Incorrectly encoded UTF-8 sequences.</li>
</ul>
<p>In these cases, the client will receive an OK response, however the tracks will not be registered.</p>
<a class="header" href="print.html#failure-handling" id="failure-handling"><h3>Failure Handling</h3></a>
<p>A hard failure at any stage should be counted by the client.
If three hard failure events occur consecutively, the client should fall back to the handshake phase.</p>
<p>If a hard failure occurs at the handshake phase, the client should initially pause
for 1 minute before handshaking again.
Subsequent failed handshakes should double this delay up to a maximum delay of 120 minutes.</p>
<p>Upon a successful handshake, the client should reset the hard failure counter.</p>
<a class="header" href="print.html#caching" id="caching"><h3>Caching</h3></a>
<p>It is recommended that the client hold submissions in a local queue if the submission process fails,
since the server connectivity may be variable (either because of network outage, or server failure).
This cache should be retained over client restarts, allowing the user to close
the client and restart later without losing their scrobbled tracks.
The cached tracks must be submitted in chronological order according to the time when they were
listened to and before any new tracks are submitted.</p>
<a class="header" href="print.html#proxy-servers" id="proxy-servers"><h3>Proxy Servers</h3></a>
<p>It is recommended that the client use whatever system-configured proxy is
in force for the HTTP scheme. The server requests will need to be modified to be proxy requests,
rather than direct server requests. This usually involves using the full URL in the
GET or POST request, rather than the components after the '/'.</p>
<a class="header" href="print.html#application-guidelines" id="application-guidelines"><h2>Application Guidelines</h2></a>
<p>There are a few things that the client should do to improve the user experience and to reduce
the impact on the submissions servers.</p>
<ul>
<li>It is important to remember that the behaviour of the client should, above everything else,
be non-intrusive to the end user in use.</li>
<li>The client should not display pop-up error messages unless absolutely necessary.
Notifications should be reported once when first identified and should not be re-displayed
unless the cause is resolved in the meantime.</li>
<li>Clients should be able to cope with long (multiples hours) downtime from the server.
This may be caused by either server failure or a lack of network connectivity by the client
(e.g. a portable system such as a laptop with only brief connectivity).</li>
</ul>
<a class="header" href="print.html#changelog" id="changelog"><h1>Changelog</h1></a>
<a class="header" href="print.html#020-21122017" id="020-21122017"><h2>0.2.0 (21.12.2017)</h2></a>
<a class="header" href="print.html#new-features" id="new-features"><h3>New features</h3></a>
<ul>
<li>Interactive date charts.</li>
</ul>
<a class="header" href="print.html#bug-fixes" id="bug-fixes"><h3>Bug fixes</h3></a>
<ul>
<li><code>last_play</code> date now is correct.</li>
<li>Return 404 when artist, album or track not found (currently on backend only).</li>
</ul>
<a class="header" href="print.html#breaking-changes" id="breaking-changes"><h3>Breaking changes</h3></a>
<ul>
<li><code>PLAYLOG_ENVIRONMENT</code> environment variable was removed in favor of <code>PLAYLOG_DEBUG</code>.</li>
<li><code>PLAYLOG_REDIS_URL</code> now requires <code>redis://</code> prefix.</li>
</ul>
<a class="header" href="print.html#other-notable-changes" id="other-notable-changes"><h3>Other notable changes</h3></a>
<ul>
<li>Added support for <code>docker-compose.overrides.yml</code> in development environment.</li>
<li><code>docker-compose</code> files updated to v3.4.</li>
<li><code>PLAYLOG_USER_EMAIL</code> environment variable is no longer required.</li>
<li>Added tests.</li>
</ul>
<a class="header" href="print.html#010-10092017" id="010-10092017"><h2>0.1.0 (10.09.2017)</h2></a>
<ul>
<li>First Release.</li>
</ul>
<a class="header" href="print.html#todo" id="todo"><h1>TODO</h1></a>
<ul>
<li>New API on server.</li>
<li>Libraries for new API</li>
<li>Proxies for Last.fm Submissions and Scrobbling API.</li>
<li>An admin interface.</li>
</ul>

                </div>

                <!-- Mobile navigation buttons -->
                

                

            </div>

            

            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        
        <script>
            $(document).ready(function() {
                window.print();
            })
        </script>
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
